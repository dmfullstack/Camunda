# @afirth 2019-05

# Make config
.SHELLFLAGS := -eu -o pipefail -c
MAKEFLAGS += --warn-undefined-variables
SHELL = /bin/bash
.SUFFIXES:

export HOSTNAME ?= camunda-bpm.example.com
export GCLOUD_PROJECT := $(shell gcloud config get-value project 2>/dev/null)

mfst := ./generated-manifest.yaml
templates = kustomization.yaml \
            skaffold.yaml \
            ingress-patch.yaml \

git_tag := $(shell git describe --always --abbrev=0 --match "NOT A TAG" --dirty="-DIRTY")

# creates and applies manifests with kustomize
.PHONY: all
all: check-kustomize manifests apply

# builds and uploads docker image, then deploys with skaffold
.PHONY: skaffold
skaffold: check-skaffold skaffold.yaml manifests
	skaffold run

# applies the manifests already generated
.PHONY: apply
apply:
	kubectl apply -f $(mfst)

# generates but doesn't deploy manifests
.PHONY: manifests
manifests: kustomization.yaml ingress-patch.yaml check-hostname check-kustomize
	@echo "## WARNING: Generated by Kustomize @$(git_tag)" > $(mfst)
	kustomize build >> $(mfst)

# generates and dry-runs the manifests
.PHONY: dry-run
dry-run: manifests
	kubectl apply -o yaml --dry-run -f $(mfst)

# delete all templates and manifests
.PHONY: clean
clean:
	rm $(templates) $(mfst)

.PHONY: $(templates)
#calls envsubst to replace things like GCLOUD_PROJECT and hostname
$(templates): %.yaml: %.yaml.tmpl
	@echo "## WARNING: Generated by make @$(git_tag)" > $@
	envsubst < $^ >> $@

# dependency checks
.PHONY: check-kustomize
check-kustomize: kustomization.yaml
	@which kustomize 1>/dev/null || (echo "kustomize not found. Try go get sigs.k8s.io/kustomize"; exit 21)

.PHONY: check-skaffold
check-skaffold: skaffold.yaml
	@which skaffold 1>/dev/null || (echo "skaffold not found. Try https://skaffold.dev/docs/getting-started/#installing-skaffold and make sure it's on your PATH"; exit 22)

.PHONY: check-hostname
check-hostname:
	@echo $(HOSTNAME) | grep -vq example.com || printf "WARNING: HOSTNAME is not set. Ingress will not work. Using the default $(HOSTNAME)\n Try make <target> HOSTNAME=<URL>\n"
